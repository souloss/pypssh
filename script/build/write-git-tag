#!/bin/bash
#
# Write the current tag to the file GITTAG. 

# 尝试获取精确匹配的标签
EXACT_TAG=$(git describe --exact-match --tags HEAD 2>/dev/null)

if [[ -n "${EXACT_TAG}" ]]; then
    # 如果获取到精确标签，直接使用
    CI_COMMIT_TAG="${EXACT_TAG}"
else
    # 获取最近的标签（包括祖先标签）
    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
    
    # 获取当前提交的短哈希
    COMMIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    
    # 获取当前分支名
    BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")
    
    # 组合版本信息
    if [[ -n "${LATEST_TAG}" ]]; then
        CI_COMMIT_TAG="dev-${LATEST_TAG}+${COMMIT_SHA}-${BRANCH_NAME}"
    else
        CI_COMMIT_TAG="dev-${COMMIT_SHA}-${BRANCH_NAME}"
    fi
    
    echo "Warning: No exact tag found. Using development version: ${CI_COMMIT_TAG}" >&2
fi

echo "${CI_COMMIT_TAG}"